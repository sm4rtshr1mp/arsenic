#! /bin/bash

quick_scan() {
    nmap --open -n -Pn -p- $1
}

accurate_punch(){
  echo "[+] Scanning $1"
  quick_scan $1 | tee /tmp/$1.txt
  ports=$(echo $(cat /tmp/$1.txt | grep open | cut -d/ -f1) | sed 's/ /,/g')
  rm /tmp/$1.txt
  if [[ -z "$ports" ]]; then
    exit
  fi
  echo "[+] Version scanning $ports"

  sudo nmap -oA recon/nmap-punched -n -Pn -sV -O -p$ports $1
}

init_host(){
  hostDir="$1"
  mkdir -p $1/loot/passwords $1/recon
  if [ ! -f $hostDir/README.md ]; then
cat <<END > $hostDir/README.md
+++
flags = ["unreviewed"]
+++
## Host info here

END

  fi
}

try_punch(){
  base_dir="hosts/$ip"
  cd $base_dir
  accurate_punch $ip
  cd - > /dev/null 2>&1
}

try_jab(){
  base_dir="hosts/$ip"
  init_host $base_dir

  cd $base_dir

  echo "[+] Scanning $1 top 1000 ports"
  nmap -oA recon/nmap-top-1000-punched -n -Pn --top-ports 1000 $1

  cd - > /dev/null 2>&1
}

fist_fight(){
  echo '[!] The fight is about to start ðŸ””'
  i=0

  # Jab
  for ip in `cat $1`; do
    i=$(( i + 1))
    try_jab &
    if [ $i -eq 3 ]; then
      while sleep 1; do
        i=$(jobs | wc -l)
        if [ $i -lt 3 ]; then
          break;
        fi
      done
    fi
  done

  # Punch
  for ip in `cat $1`; do
    i=$(( i + 1))
    try_punch &
    if [ $i -eq 3 ]; then
      while sleep 1; do
        i=$(jobs | wc -l)
        if [ $i -lt 3 ]; then
          break;
        fi
      done
    fi
  done
  wait
  echo '[!] The fist fight is over ðŸŽ‰'
}

if [ -z $1 ]; then
  # no longer using -A
  # echo Warning: This script is Aggressive
  echo "`basename $0` [ scope_file | target ]"
  exit
fi

if [ -f $1 ]; then
  # its a file, lets treat each line as a host
  fist_fight $1
else
  # not a fil, treat it as a host
  accurate_punch $1
fi
